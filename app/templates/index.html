{% extends "base.html" %}
{% block content %}
  <section class="grid items-start gap-8 lg:grid-cols-[1.2fr_0.8fr]">
    <div class="rounded-3xl border border-white/10 bg-white/5 p-8 shadow-2xl shadow-emerald-500/10 backdrop-blur">
      <div class="flex flex-wrap items-center gap-3 text-xs font-semibold uppercase tracking-[0.25em] text-emerald-200">
        <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-emerald-50">fastapi-users</span>
        {% if user %}
          <span class="rounded-full bg-white/10 px-3 py-1 text-white">Hi, {{ user.full_name or user.email }}</span>
        {% else %}
          <span class="rounded-full bg-white/10 px-3 py-1 text-white">Auth-ready Template</span>
        {% endif %}
      </div>
      <h1 class="mt-4 text-4xl font-semibold leading-tight text-white sm:text-5xl">
        Ein hübsches Client-Portal mit FastAPI Users & Tailwind.
      </h1>
      <p class="mt-4 max-w-3xl text-lg text-slate-200">
        Vorverkabelte Authentifizierung, saubere SQLAlchemy Models und ein ansprechendes UI. Nutze die API-Routen
        von <span class="text-emerald-200">fastapi-users</span> oder die eingebauten Formulare, um sofort loszulegen.
      </p>
      <div class="mt-6 flex flex-wrap gap-3">
        <a
          href="#register"
          class="rounded-full bg-gradient-to-r from-emerald-400 to-sky-500 px-5 py-3 text-sm font-semibold text-slate-950 shadow-lg shadow-emerald-500/30 transition hover:from-emerald-300 hover:to-sky-400"
        >
          Jetzt registrieren
        </a>
        <a
          href="#login"
          class="rounded-full border border-white/15 bg-white/5 px-5 py-3 text-sm font-semibold text-white transition hover:border-emerald-200/70 hover:bg-white/10"
        >
          Einloggen
        </a>
        {% if user %}
          <a
            href="/dashboard"
            class="rounded-full border border-emerald-300/50 bg-emerald-500/15 px-5 py-3 text-sm font-semibold text-emerald-100 transition hover:bg-emerald-500/25"
          >
            Dashboard öffnen
          </a>
        {% endif %}
      </div>
      <div class="mt-8 grid gap-4 sm:grid-cols-3">
        <div class="rounded-2xl border border-white/5 bg-gradient-to-b from-white/10 to-slate-900/40 p-4">
          <p class="text-xs uppercase tracking-wide text-emerald-200">Mitglieder</p>
          <p class="mt-2 text-3xl font-semibold text-white">{{ stats.total if stats else 0 }}</p>
          <p class="text-sm text-slate-300">Accounts gesamt</p>
        </div>
        <div class="rounded-2xl border border-white/5 bg-gradient-to-b from-white/10 to-slate-900/40 p-4">
          <p class="text-xs uppercase tracking-wide text-emerald-200">Aktiv</p>
          <p class="mt-2 text-3xl font-semibold text-white">{{ stats.active if stats else 0 }}</p>
          <p class="text-sm text-slate-300">Aktive Sessions</p>
        </div>
        <div class="rounded-2xl border border-white/5 bg-gradient-to-b from-white/10 to-slate-900/40 p-4">
          <p class="text-xs uppercase tracking-wide text-emerald-200">Verifiziert</p>
          <p class="mt-2 text-3xl font-semibold text-white">{{ stats.verified if stats else 0 }}</p>
          <p class="text-sm text-slate-300">E-Mail bestätigt</p>
        </div>
      </div>
    </div>

    <div class="rounded-3xl border border-white/10 bg-gradient-to-b from-slate-900/50 via-slate-900/30 to-slate-950/60 p-6 shadow-2xl shadow-slate-900/50 backdrop-blur">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-emerald-200">Aktuelle Mitglieder</p>
          <p class="text-lg font-semibold text-white">Letzte Sign-ups</p>
        </div>
        <div class="rounded-full bg-emerald-500/20 px-3 py-1 text-xs font-semibold text-emerald-100">
          Live
        </div>
      </div>
      <div class="mt-4 space-y-3">
        {% if users %}
          {% for member in users %}
            <div class="flex items-center justify-between rounded-2xl border border-white/5 bg-white/5 px-4 py-3">
              <div>
                <p class="text-sm font-semibold text-white">{{ member.full_name }}</p>
                <p class="text-xs text-slate-300">{{ member.email }}</p>
              </div>
              <div class="flex items-center gap-2">
                {% if member.is_verified %}
                  <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-100">
                    Verifiziert
                  </span>
                {% else %}
                  <span class="rounded-full bg-white/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-white/80">
                    Neu
                  </span>
                {% endif %}
                <span class="hidden text-[11px] text-slate-400 sm:inline">
                  {{ member.created_at.strftime("%d.%m.%Y") if member.created_at else "soeben" }}
                </span>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="rounded-2xl border border-dashed border-white/10 bg-white/5 p-4 text-sm text-slate-300">
            Noch keine User angelegt. Registriere dich unten und sieh zu, wie dieses Panel zum Leben erwacht.
          </p>
        {% endif %}
      </div>
      <div class="mt-5 rounded-2xl border border-emerald-200/20 bg-emerald-500/10 px-4 py-3 text-sm text-emerald-50">
        Tipp: Die API-Routen findest du unter <code class="rounded bg-white/10 px-2 py-1 text-xs">/auth</code> und
        <code class="rounded bg-white/10 px-2 py-1 text-xs">/api/users</code>.
      </div>
    </div>
  </section>

  <section class="mt-12 grid gap-6 lg:grid-cols-2" id="register">
    <div class="rounded-3xl border border-white/10 bg-white/5 p-6 shadow-2xl shadow-emerald-500/10 backdrop-blur">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-emerald-200">Neu hier?</p>
          <h2 class="mt-1 text-2xl font-semibold text-white">Registrieren</h2>
          <p class="text-sm text-slate-300">Leg direkt einen Account über fastapi-users an.</p>
        </div>
        <span class="rounded-full bg-emerald-500/20 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-100">
          sicher
        </span>
      </div>
      <form id="register-form" class="mt-5 space-y-4">
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-300">Voller Name</label>
          <input
            type="text"
            name="full_name"
            placeholder="Alex Example"
            class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/60 px-4 py-3 text-sm text-white outline-none ring-2 ring-transparent transition focus:border-emerald-300/60 focus:ring-emerald-500/30"
            required
          />
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-300">E-Mail</label>
          <input
            type="email"
            name="email"
            placeholder="you@example.com"
            class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/60 px-4 py-3 text-sm text-white outline-none ring-2 ring-transparent transition focus:border-emerald-300/60 focus:ring-emerald-500/30"
            required
          />
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-300">Passwort</label>
            <input
              type="password"
              name="password"
              placeholder="••••••••"
              minlength="8"
              class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/60 px-4 py-3 text-sm text-white outline-none ring-2 ring-transparent transition focus:border-emerald-300/60 focus:ring-emerald-500/30"
              required
            />
          </div>
          <div>
            <label class="text-xs font-semibold uppercase tracking-wide text-slate-300">Passwort bestätigen</label>
            <input
              type="password"
              name="password_confirm"
              placeholder="••••••••"
              minlength="8"
              class="mt-1 w-full rounded-xl border border-white/10 bg-slate-900/60 px-4 py-3 text-sm text-white outline-none ring-2 ring-transparent transition focus:border-emerald-300/60 focus:ring-emerald-500/30"
              required
            />
          </div>
        </div>
        <button
          type="submit"
          class="flex w-full items-center justify-center rounded-xl bg-gradient-to-r from-emerald-400 to-sky-500 px-4 py-3 text-sm font-semibold text-slate-950 shadow-lg shadow-emerald-500/30 transition hover:from-emerald-300 hover:to-sky-400"
        >
          Account anlegen & direkt anmelden
        </button>
      </form>
      <p class="mt-4 text-xs text-slate-400">
        Wir nutzen die Registration- und Login-Routen von <span class="text-emerald-200">fastapi-users</span>, Cookies
        werden automatisch gesetzt.
      </p>
    </div>

    <div class="rounded-3xl border border-white/10 bg-slate-900/60 p-6 shadow-2xl shadow-slate-900/50 backdrop-blur" id="login">
      <div class="flex items-start justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.2em] text-emerald-200">Schon dabei?</p>
          <h2 class="mt-1 text-2xl font-semibold text-white">Login</h2>
          <p class="text-sm text-slate-300">Hol dir einen frischen Auth-Cookie.</p>
        </div>
        <span class="rounded-full bg-white/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-white/80">
          JWT + Cookie
        </span>
      </div>
      <form id="login-form" class="mt-5 space-y-4">
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-300">E-Mail</label>
          <input
            type="email"
            name="email"
            placeholder="you@example.com"
            class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none ring-2 ring-transparent transition focus:border-emerald-300/60 focus:ring-emerald-500/30"
            required
          />
        </div>
        <div>
          <label class="text-xs font-semibold uppercase tracking-wide text-slate-300">Passwort</label>
          <input
            type="password"
            name="password"
            placeholder="••••••••"
            minlength="8"
            class="mt-1 w-full rounded-xl border border-white/10 bg-slate-950/80 px-4 py-3 text-sm text-white outline-none ring-2 ring-transparent transition focus:border-emerald-300/60 focus:ring-emerald-500/30"
            required
          />
        </div>
        <button
          type="submit"
          class="flex w-full items-center justify-center rounded-xl border border-emerald-200/40 bg-emerald-500/15 px-4 py-3 text-sm font-semibold text-emerald-100 transition hover:bg-emerald-500/25"
        >
          Login & zum Dashboard
        </button>
      </form>
      <div class="mt-4 flex flex-wrap gap-3 text-xs text-slate-400">
        <span class="rounded-full bg-white/5 px-3 py-1">/auth/login</span>
        <span class="rounded-full bg-white/5 px-3 py-1">Cookies aktiviert</span>
        <span class="rounded-full bg-white/5 px-3 py-1">Automatischer Redirect</span>
      </div>
      {% if user %}
        <div class="mt-5 flex items-center justify-between rounded-2xl border border-white/10 bg-white/5 px-4 py-3">
          <div>
            <p class="text-sm font-semibold text-white">{{ user.full_name or user.email }}</p>
            <p class="text-xs text-slate-300">{{ user.email }}</p>
          </div>
          <button
            id="logout-button"
            class="rounded-full border border-white/15 bg-white/10 px-4 py-2 text-xs font-semibold text-white transition hover:border-rose-200/60 hover:bg-rose-500/20 hover:text-rose-50"
          >
            Logout
          </button>
        </div>
      {% endif %}
    </div>
  </section>

  <section class="mt-10 grid gap-4 sm:grid-cols-3">
    <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
      <p class="text-sm font-semibold text-white">Auth per Cookie</p>
      <p class="mt-1 text-xs text-slate-300">CookieTransport + JWTStrategy, ready für Browser-Apps.</p>
    </div>
    <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
      <p class="text-sm font-semibold text-white">Async SQLAlchemy</p>
      <p class="mt-1 text-xs text-slate-300">Sauberer Async-Stack inkl. get_db Dependency.</p>
    </div>
    <div class="rounded-2xl border border-white/10 bg-white/5 p-4">
      <p class="text-sm font-semibold text-white">Tailwind UI</p>
      <p class="mt-1 text-xs text-slate-300">Ready für deinen Brand – ändere nur Farben & Copy.</p>
    </div>
  </section>

  <div
    id="toast"
    class="fixed bottom-6 left-1/2 z-50 hidden -translate-x-1/2 rounded-2xl border border-emerald-300/40 bg-emerald-500/80 px-4 py-3 text-sm font-semibold text-slate-950 shadow-xl shadow-emerald-500/30 backdrop-blur"
  ></div>

  <script>
    const toast = document.getElementById("toast");
    const showToast = (message, mode = "success") => {
      toast.textContent = message;
      toast.classList.remove("hidden");
      toast.classList.toggle("bg-emerald-500/80", mode === "success");
      toast.classList.toggle("bg-rose-500/80", mode === "error");
      setTimeout(() => toast.classList.add("hidden"), 2800);
    };

    const loginWithCredentials = async (email, password) => {
      const body = new URLSearchParams();
      body.set("username", email);
      body.set("password", password);
      const res = await fetch("/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body,
        credentials: "include",
      });
      if (!res.ok) {
        const msg = (await res.json())?.detail || "Login fehlgeschlagen";
        throw new Error(msg);
      }
    };

    const registerForm = document.getElementById("register-form");
    registerForm?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const data = new FormData(registerForm);
      const password = data.get("password");
      const confirm = data.get("password_confirm");

      if (password !== confirm) {
        showToast("Passwörter stimmen nicht überein.", "error");
        return;
      }

      const payload = {
        email: data.get("email"),
        password,
        full_name: data.get("full_name"),
      };

      try {
        const res = await fetch("/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          credentials: "include",
        });

        if (!res.ok) {
          const detail = (await res.json())?.detail || "Registrierung fehlgeschlagen";
          throw new Error(typeof detail === "string" ? detail : JSON.stringify(detail));
        }

        await loginWithCredentials(payload.email, password);
        showToast("Erfolgreich registriert – willkommen!");
        setTimeout(() => (window.location.href = "/dashboard"), 700);
      } catch (error) {
        showToast(error.message, "error");
      }
    });

    const loginForm = document.getElementById("login-form");
    loginForm?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const data = new FormData(loginForm);
      try {
        await loginWithCredentials(data.get("email"), data.get("password"));
        showToast("Eingeloggt!");
        setTimeout(() => (window.location.href = "/dashboard"), 600);
      } catch (error) {
        showToast(error.message, "error");
      }
    });

    const logoutButton = document.getElementById("logout-button");
    logoutButton?.addEventListener("click", async () => {
      await fetch("/auth/logout", { method: "POST", credentials: "include" });
      window.location.href = "/";
    });
  </script>
{% endblock %}
